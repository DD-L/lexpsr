<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正则表达式自动机可视化工具</title>
    <!-- script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js"></script -->
    <!-- script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.1.1/mermaid.min.js"></script -->
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        .input-area {
            margin-bottom: 20px;
        }
        .input-area input {
            margin-right: 10px;
            padding: 5px;
        }
        .output-area {
            margin-bottom: 20px;
        }
        #regex-input {
            width: 100%;
        }
        #output-log {
            width: 100%;
            height: 100px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
        }
        .graph-area {
            display: flex;
            justify-content: space-between;
        }
        .graph-section {
            width: 32%;
        }
        .mermaid-data {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
        }
        .render-button {
            margin-bottom: 10px;
        }
        .mermaid-output {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <h1>正则表达式自动机可视化工具</h1>
    
    <div class="input-area">
        <input type="text" id="regex-input" placeholder="输入正则表达式">
        <br>
        <!-- input type="text" id="modifiers-input" placeholder="输入修饰符" -->

        <label>
            <input type="checkbox" id="ignoreCase">忽略大小写  &nbsp;&nbsp; | &nbsp;&nbsp;
        </label>
        <label>
            <input type="checkbox" id="nonGreedy">非贪婪  &nbsp;&nbsp; | &nbsp;&nbsp;
        </label>
        <label>
            <input type="checkbox" id="disableDot">禁用 dot(.) 匹配所有（. 等价于 [^\r\n]）
        </label>

        <br>
        <button id="generate-button">生成结果</button>
    </div>
    
    <div class="output-area">
        <h2>输出日志</h2>
        <div id="output-log"></div>
    </div>
    
    <div class="graph-area">
        <div class="graph-section">
            <h2>e-NFA</h2>
            <textarea class="mermaid-data" id="enfa-data"></textarea>
            <button class="render-button" id="render-button" onclick="renderMermaid('enfa-data', 'enfa-output')">渲染 e-NFA</button>
            <div class="mermaid-output" id="enfa-output"></div>
        </div>
        
        <div class="graph-section">
            <h2>DFA</h2>
            <textarea class="mermaid-data" id="dfa-data"></textarea>
            <button class="render-button" id="render-button" onclick="renderMermaid('dfa-data', 'dfa-output')">渲染 DFA</button>
            <div class="mermaid-output" id="dfa-output"></div>
        </div>
        
        <div class="graph-section">
            <h2>极小化 DFA</h2>
            <textarea class="mermaid-data" id="min-dfa-data"></textarea>
            <button class="render-button" id="render-button" onclick="renderMermaid('min-dfa-data', 'min-dfa-output')">渲染极小化 DFA</button>
            <div class="mermaid-output" id="min-dfa-output"></div>
        </div>
    </div>
    
    <script type="module">
        // import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
        import mermaid from "./js/mermaid.esm.min.mjs";
        mermaid.initialize({
            startOnLoad: false,
            theme: "default",
            flowchart: {
                curve: 'basis',  // 设置为曲线, 使得指向自己的弧线更自然
            }
        });

        function renderMermaid(dataId, outputId) {
            const input = document.getElementById(dataId).value;
            const output = document.getElementById(outputId);
            try {
                //output.innerHTML = input;  // 将输入内容直接放入输出容器
                //mermaid.init(undefined, output);  // 初始化并渲染 Mermaid 图
                
                // 清空输出容器
				output.innerHTML = '';

				// 创建一个新的 div 来放置渲染的图形
				const graphDiv = document.createElement('div');
				graphDiv.innerHTML = input;

				// 将新的 graphDiv 添加到输出容器
				output.appendChild(graphDiv);

				// 初始化并渲染新的 Mermaid 图
				mermaid.init(undefined, graphDiv);
            } catch (error) {
                output.innerHTML = '<p style="color:red;">Invalid Mermaid syntax!</p>';
            }
        }

        window.renderMermaid = renderMermaid;
    </script>

    <script src="js/regex_builder.js"></script>
    <script> 
        // Load the module
        MyModule().then(Module => {

            const regexBuilder = new Module.RegexBuilder();

            function clear_result() {
                // 清空之前的结果
                document.getElementById('output-log').innerHTML = '';
                document.getElementById('enfa-data').value = '';
                document.getElementById('dfa-data').value = '';
                document.getElementById('min-dfa-data').value = '';
                document.getElementById('enfa-output').innerHTML = '';
                document.getElementById('dfa-output').innerHTML = '';
                document.getElementById('min-dfa-output').innerHTML = '';
            }

            function calc() {
                clear_result();

                const regex = document.getElementById('regex-input').value;
                //const modifiers = parseInt(document.getElementById('modifiers-input').value) || 0;
                logOutput('正在处理正则表达式: ' + regex);
                const caseless = document.getElementById('ignoreCase').checked;
                const nonGreedy = document.getElementById('nonGreedy').checked;
                const dotNotAll = document.getElementById('disableDot').checked;

                if (caseless) {
                    logOutput('启用修饰: 忽略大小写');
                }
                if (nonGreedy) {
                    logOutput('启用修饰: 非贪婪');
                }
                if (dotNotAll) {
                    logOutput('启用修饰: 禁用 dot(.) 匹配所有（. 等价于 [^\\r\\n])');
                }
                var modifiers = Module.CalcModifiers(caseless, nonGreedy, dotNotAll);
                logOutput('使用修饰符: ' + modifiers);


 
                var ast = new Module.RegexAST(); 
                const res1 = Module.RegexBuilderToAST(regexBuilder, regex, modifiers, ast);
                if (!res1.result) {
                   logOutput('转换 AST 错误: ' + res1.error.replace(/\n/g, '<br>'));
                   return;
                }

                const astStr = Module.DumpAST(ast);
                logOutput('AST: ' + astStr);

                var nfa = new Module.EpsilonNFA();
                const res2 = Module.ASTToNFA(ast, nfa);
                if (!res2.result) {
                   logOutput('AST 转换 NFA 错误: ' + res2.error.replace(/\n/g, '<br>'));
                   return;
                }

                const enfaData = Module.NFAToMermaid(nfa); 
                document.getElementById('enfa-data').value = enfaData;

                var dfa = new Module.DFA(); 
                const res3 = Module.NFAToDFA(nfa, dfa);
                if (!res3.result) {
                   logOutput('NFA 转换 DFA 错误: ' + res3.error.replace(/\n/g, '<br>'));
                   return;
                }

                const dfaData = Module.DFAToMermaid(dfa); 
                document.getElementById('dfa-data').value = dfaData;

                if (!Module.TryMinimizeDFA(dfa)) {
                   logOutput('尝试极小化 DFA 失败!');
                   //document.getElementById('min-dfa-data').value = dfaData;
                }
                else {
                   const minDfaData = Module.DFAToMermaid(dfa);
                   document.getElementById('min-dfa-data').value = minDfaData;
                }


                logOutput('处理完成');

            } // function calc
            // function.calc = calc;
            document.getElementById('generate-button').addEventListener('click', calc);
        });

        function logOutput(message) {
            const logElement = document.getElementById('output-log');
            logElement.innerHTML += message + '<br>';
            logElement.scrollTop = logElement.scrollHeight;
        }
    </script>
</body>
</html>
